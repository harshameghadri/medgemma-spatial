name: Deploy to HuggingFace Spaces

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Push to HuggingFace Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        # Build a clean deploy tree: app/ + src/ only (no large notebooks)
        mkdir -p /tmp/hf-deploy
        cp -r app/. /tmp/hf-deploy/
        cp -r src /tmp/hf-deploy/src

        # Write HF Spaces README with required YAML frontmatter
        cat > /tmp/hf-deploy/README.md << 'READMEEOF'
        ---
        title: MedGemma Spatial Transcriptomics
        emoji: ðŸ”¬
        colorFrom: blue
        colorTo: purple
        sdk: docker
        app_port: 8501
        pinned: false
        license: mit
        ---

        # MedGemma Spatial Transcriptomics

        AI-powered spatial transcriptomics analysis â€” upload a 10x Visium .h5ad file and receive an automated clinical pathology report generated by MedGemma 4B-it.

        **Source**: [GitHub](https://github.com/harshameghadri/medgemma-spatial)
        READMEEOF

        # Fix Dockerfile paths: it was written for repo-root context, adapt for HF deploy
        cat > /tmp/hf-deploy/Dockerfile << 'DOCKEREOF'
        FROM python:3.10-slim

        ENV PYTHONUNBUFFERED=1 PYTHONDONTWRITEBYTECODE=1 PIP_NO_CACHE_DIR=1

        RUN apt-get update && apt-get install -y --no-install-recommends \
            build-essential git curl \
            && rm -rf /var/lib/apt/lists/*

        RUN useradd -m -u 1000 medgemma && \
            mkdir -p /app /data /output && \
            chown -R medgemma:medgemma /app /data /output

        WORKDIR /app
        COPY requirements.txt /app/requirements.txt
        RUN pip install --no-cache-dir -r requirements.txt

        COPY --chown=medgemma:medgemma src/ /app/src/
        COPY --chown=medgemma:medgemma streamlit_app.py /app/

        USER medgemma
        ENV PATH=/home/medgemma/.local/bin:$PATH PYTHONPATH=/app:$PYTHONPATH

        HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
            CMD curl -f http://localhost:8501/_stcore/health || exit 1

        EXPOSE 8501
        CMD ["streamlit", "run", "streamlit_app.py", \
             "--server.port=8501", "--server.address=0.0.0.0", \
             "--server.headless=true", "--server.fileWatcherType=none", \
             "--browser.gatherUsageStats=false"]
        DOCKEREOF

        cd /tmp/hf-deploy
        git init -b main
        git config user.email "actions@github.com"
        git config user.name "GitHub Actions"
        git remote add hf https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/medgemma-spatial
        git add .
        git commit -m "deploy: update Space from GitHub Actions"
        git push hf main --force

  deploy-vercel:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to Vercel
      run: npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --cwd vercel/
      continue-on-error: true
